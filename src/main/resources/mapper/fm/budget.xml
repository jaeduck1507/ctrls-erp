<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.fm.mapper.BudgetMapper">
	
	<resultMap id="BudgetDeptMap" type="BudgetDeptDTO">
		<id property="budgetNo" column="budget_no"/>
		<result property="periodType" column="period_type"/>
		<result property="periodValue" column="period_value"/>
		<result property="annualBudget" column="annual_budget"/>
		<result property="plan" column="plan"/>
		<result property="executionDate" column="execution_date"/>
		<result property="deptName" column="dept_name"/>
	</resultMap>
	
	<select id="showBudget" parameterType="BudgetDeptDTO" resultMap="BudgetDeptMap">
		SELECT * FROM budget
		JOIN department USING(dept_no)
		<where>
			<if test="yearMonth != null">
				execution_date LIKE CONCAT('%', #{yearMonth}, '%')
			</if>
			<if test="deptName != 'all'">
				AND dept_name = #{deptName}
			</if>
		</where>
		ORDER BY budget_no
	</select>
	
	<select id="showBudgetPage" parameterType="BudgetPagingDTO" resultMap="BudgetDeptMap">
		SELECT * FROM budget
		JOIN department USING(dept_no)
		<where>
			<if test="budgetDeptDTO.yearMonth != null">
				execution_date LIKE CONCAT('%', #{budgetDeptDTO.yearMonth}, '%')
			</if>
			<if test="budgetDeptDTO.deptName != 'all'">
				AND dept_name = #{budgetDeptDTO.deptName}
			</if>
		</where>
		ORDER BY budget_no
		LIMIT #{offset}, #{limit}
	</select>
	
	<select id="totalBudgetPage" parameterType="BudgetDeptDTO" resultType="int">
		SELECT count(*) FROM budget
		JOIN department USING(dept_no)
		<where>
			<if test="yearMonth != null">
				execution_date LIKE CONCAT('%', #{yearMonth}, '%')
			</if>
			<if test="deptName != 'all'">
				AND dept_name = #{deptName}
			</if>
		</where>
		ORDER BY budget_no
	</select>
	
	<insert id="budgetRegister" parameterType="ArrayList">
		INSERT INTO budget(period_type, annual_budget, plan, execution_date, dept_no) VALUES
		<foreach collection="bList" item="budget" separator=",">
		(#{budget.periodType},#{budget.annualBudget},#{budget.plan},#{budget.executionDate},#{budget.deptNo})
		</foreach>
	</insert>
	
	<update id="updatePV" parameterType="Budget">
		UPDATE budget SET period_value = CONCAT(YEAR(execution_date), '-', period_type, budget_no)
	</update>
	
	<select id="searchBudget" parameterType="BudgetDeptDTO" resultMap="BudgetDeptMap">
		SELECT * FROM budget
		JOIN department USING(dept_no)
		WHERE budget_no = #{budgetNo}
	</select>
	
	<update id="budgetUpdate" parameterType="Budget">
		UPDATE budget
		<set>
			period_type = #{periodType},
			annual_budget = #{annualBudget},
			plan = #{plan},
			execution_date = #{executionDate}
		</set>
		WHERE budget_no = #{budgetNo}
	</update>
	
	<delete id="budgetDelete" parameterType="int">
		DELETE FROM budget 
		WHERE budget_no = #{budgetNo}
	</delete>
</mapper>