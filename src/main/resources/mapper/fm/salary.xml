<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.fm.mapper.SalaryMapper">

	<resultMap id="SalEmpMap" type="SalEmpDTO">
		<id property="salaryNo" column="salary_no"/>
		<result property="salaryDate" column="salary_date"/>
		<result property="baseSalary" column="base_salary"/>
		<result property="bonus" column="bonus"/>
		<result property="deduction" column="deduction"/>
		<result property="tax" column="tax"/>
		<result property="empNo" column="emp_no"/>
		<result property="empName" column="emp_name"/>
		<result property="deptNo" column="dept_no"/>
		<result property="deptName" column="dept_name"/>
		<result property="totalSal" column="total_sal"/>
	</resultMap>
	
	<resultMap id="SalaryDTOtMap" type="SalaryDTO">
		<id property="salaryNo" column="salary_no"/>
		<result property="salaryDate" column="salary_date"/>
		<result property="baseSalary" column="base_salary"/>
		<result property="bonus" column="bonus"/>
		<result property="deduction" column="deduction"/>
		<result property="tax" column="tax"/>
		<result property="empNo" column="emp_no"/>
		<result property="bonusPaymentNo" column="bonus_payment_no"/>
		<result property="empName" column="emp_name"/>
		<result property="deptName" column="dept_name"/>
		<result property="jobTitle" column="job_title"/>
		<result property="payment" column="payment"/>
	</resultMap>
	
	<select id="showSalary" parameterType="SalEmpDTO" resultMap="SalEmpMap">
		SELECT emp_no, dept_name, emp_name, salary_date, base_salary, bonus, deduction, tax
		FROM salary 
		JOIN employee_info USING(emp_no)
		JOIN department USING(dept_no)
		<where>
			<if test="yearMonth != null">
				salary_date LIKE CONCAT ('%', #{yearMonth}, '%')
			</if>
			<if test="deptName != 'dept'">
				AND dept_name = #{deptName}
			</if>
			<if test="empName != null">
				AND emp_name LIKE CONCAT ('%', #{empName}, '%')
			</if>
		</where>
		ORDER BY salary_date desc
	</select>
	
	<select id="showSalaryPage" parameterType="SalaryPagingDTO" resultMap="SalEmpMap">
		SELECT emp_no, dept_name, emp_name, salary_date, base_salary, bonus, deduction, tax
		FROM salary 
		JOIN employee_info USING(emp_no)
		JOIN department USING(dept_no)
		<where>
			<if test="salEmpDTO.yearMonth != null">
				salary_date LIKE CONCAT ('%', #{salEmpDTO.yearMonth}, '%')
			</if>
			<if test="salEmpDTO.deptName != 'dept'">
				AND dept_name = #{salEmpDTO.deptName}
			</if>
			<if test="salEmpDTO.empName != null">
				AND emp_name LIKE CONCAT ('%', #{salEmpDTO.empName}, '%')
			</if>
		</where>
		ORDER BY salary_date desc
		LIMIT #{offset}, #{limit}
	</select>
	
	<select id="totalSalaryPage" parameterType="SalEmpDTO" resultType="int">
		SELECT count(*)
		FROM salary 
		JOIN employee_info USING(emp_no)
		JOIN department USING(dept_no)
		<where>
			<if test="yearMonth != null">
				salary_date LIKE CONCAT ('%', #{yearMonth}, '%')
			</if>
			<if test="deptName != 'dept'">
				AND dept_name = #{deptName}
			</if>
			<if test="empName != null">
				AND emp_name LIKE CONCAT ('%', #{empName}, '%')
			</if>
		</where>
		ORDER BY salary_date desc
	</select>
	
	<select id="salaryPayment" parameterType="SalaryAlreadyAddDTO" resultMap="SalaryDTOtMap">
	SELECT emp_no, emp_name,dept_name,job_title,(salary+IFNULL(sum(quit_pay),0)) as 'base_salary',IFNULL(sum(payment),0) as 'bonus',IFNULL(sum(quit_pay),0) as quit_pay
	FROM salary
	RIGHT JOIN employee_info using(emp_no)
	LEFT JOIN bonus_payment USING(emp_no)
	JOIN department USING(dept_no)
	JOIN job_position USING(job_no)
	LEFT JOIN(
	select emp_no, quit_pay
	from quitter
	where quit_pay_date like CONCAT('%', #{yearMonth}, '%')
	) as q USING(emp_no)
	
	<where>
	pay_date like CONCAT('%', #{yearMonth}, '%')
	and IFNULL(quit_date,'2050-01-01') <![CDATA[>=]]> CONCAT(#{lastMonth},'-1')
	<if test="list.size != 0">
				<foreach collection="list" item = "emp">
					AND emp_no != #{emp.empNo}
				</foreach>
			</if>
	</where>
	GROUP BY emp_no
	</select>
	
	<select id="salaryPaymentNoBonus" parameterType="SalaryAlreadyAddDTO" resultMap="SalaryDTOtMap">
		SELECT DISTINCT emp_no, emp_name,dept_name,job_title,(salary+IFNULL(quit_pay,0)) as 'base_salary'
		FROM salary
		RIGHT JOIN employee_info using(emp_no)
		JOIN department USING(dept_no)
		JOIN job_position USING(job_no)
		LEFT JOIN(
	select emp_no, quit_pay
	from quitter
	where quit_pay_date like CONCAT('%', #{yearMonth}, '%')
	) AS q USING(emp_no)
		<where>
			IFNULL(quit_date,'2050-01-01') <![CDATA[>=]]> CONCAT(#{lastMonth},'-1')
			
			<if test="list.size != 0">
				<foreach collection="list" item = "emp">
					AND emp_no != #{emp.empNo}
				</foreach>
			</if>
		</where>
	order by emp_no
	</select>
	
	<insert id="addSalaryPayment" parameterType="arrayList">
		INSERT INTO salary(salary_date, base_salary, bonus, deduction,emp_no)
		VALUES
		<foreach collection="spList" item="emp" separator=",">
		(#{emp.salaryDate},#{emp.baseSalary},#{emp.bonus},#{emp.deduction},#{emp.empNo})
		
		</foreach>
	</insert>	
	
	<select id="showSalaryAlreadyAdd" parameterType="SalaryAlreadyAddDTO" resultMap="SalaryDTOtMap">
	select emp_no from salary
	JOIN employee_info USING(emp_no)
	WHERE salary_date LIKE CONCAT('%', #{yearMonth}, '%')
	</select>
	
	<select id="totalSalary" parameterType="SalEmpDTO" resultMap="SalEmpMap">
		SELECT dept_no, dept_name, salary_date, SUM(base_salary+bonus-deduction) AS total_sal
		FROM salary
		JOIN employee_info USING(emp_no)
		JOIN department USING(dept_no)
		WHERE salary_date LIKE CONCAT('%', #{yearMonth}, '%')
		GROUP BY dept_no, dept_name, salary_date
		ORDER BY dept_no
	</select>
</mapper>