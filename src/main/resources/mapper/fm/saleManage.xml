<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.fm.mapper.SaleManageMapper">

	<resultMap id="SaleProductMap" type="SaleProductDTO">
		<id property="smNo" column="sm_no" />
		<result property="saleDate" column="sale_date"/>
		<result property="quantity" column="quantity"/>
		<result property="varAmount" column="var_amount"/>
		<result property="totalAmount" column="total_amount"/>
		<result property="productName" column="product_name"/>
		<result property="productPrice" column="product_price"/>
		<result property="productCategory" column="product_category"/>
		<result property="dailySales" column="daily_sales"/>
	</resultMap>
	
	<select id="showSaleManage" parameterType="SaleProductDTO" resultMap="SaleProductMap">
		SELECT sm_no, sale_date, quantity, var_amount, total_amount, product_name, product_price, product_category
		FROM sale_manage
		JOIN product_name USING(product_code)
		<where>
			<if test="startDate != null and endDate != null">
				sale_date BETWEEN #{startDate} AND #{endDate}
			</if>
			<if test="productCategory != 'all'">
				AND product_category = #{productCategory}
			</if>
			<if test="productName != null">
				AND product_name LIKE CONCAT ('%', #{productName}, '%')
			</if>
		</where>
		ORDER BY sale_date
	</select>
	
	<select id="showSaleManagePage" parameterType="SaleManagePagingDTO" resultMap="SaleProductMap">
		SELECT sm_no, sale_date, quantity, var_amount, total_amount, product_name, product_price, product_category
		FROM sale_manage
		JOIN product_name USING(product_code)
		<where>
			<if test="saleProductDTO.startDate != null and saleProductDTO.endDate != null">
				sale_date BETWEEN #{saleProductDTO.startDate} AND #{saleProductDTO.endDate}
			</if>
			<if test="saleProductDTO.productCategory != 'all'">
				AND product_category = #{saleProductDTO.productCategory}
			</if>
			<if test="saleProductDTO.productName != null">
				AND product_name LIKE CONCAT ('%', #{saleProductDTO.productName}, '%')
			</if>
		</where>
		ORDER BY sale_date
		LIMIT #{offset}, #{limit}
	</select>
	
	<select id="totalSaleManagePage" parameterType="SaleProductDTO" resultType="int">
		SELECT count(*)
		FROM sale_manage
		JOIN product_name USING(product_code)
		<where>
			<if test="startDate != null and endDate != null">
				sale_date BETWEEN #{startDate} AND #{endDate}
			</if>
			<if test="productCategory != 'all'">
				AND product_category = #{productCategory}
			</if>
			<if test="productName != null">
				AND product_name LIKE CONCAT ('%', #{productName}, '%')
			</if>
		</where>
		ORDER BY sale_date
	</select>
	
	<insert id="saleRegister" parameterType="ArrayList">
		INSERT INTO sale_manage(sale_date, quantity, var_amount, total_amount, product_code) VALUES
		<foreach collection="smList" item="saleManage" separator=",">
		(#{saleManage.saleDate},#{saleManage.quantity},#{saleManage.varAmount},#{saleManage.totalAmount},#{saleManage.productCode})
		</foreach>
	</insert>
	
	<select id="totalSales" parameterType="SaleProductDTO" resultMap="SaleProductMap">
		SELECT sale_date, SUM(total_amount) AS daily_sales
		FROM sale_manage
		WHERE sale_date = #{saleDate}
	</select>
</mapper>