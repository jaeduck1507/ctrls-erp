<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.fm.mapper.TransactionMapper">
	
	<resultMap id="TransMap" type="TransDTO">
		<id property="transNo" column="trans_no"/>
		<result property="transType" column="trans_type"/>
		<result property="transAmount" column="trans_amount"/>
		<result property="category" column="category"/>
		<result property="transDesc" column="trans_desc"/>
		<result property="transDate" column="trans_date"/>
		<result property="deptNo" column="dept_no"/>
		<result property="deptName" column="dept_name"/>
		<result property="transMonth" column="trans_month"/>
		<result property="monthIncome" column="month_income"/>
		<result property="monthExpenses" column="month_expenses"/>
	</resultMap>
	
	<resultMap id="BalanceMap" type="BalanceDTO">
		<result property="deptNo" column="dept_no" />
		<result property="deptName" column="dept_name" />
		<result property="expenses" column="expenses" />
	</resultMap>
	
	<select id="showtrans" parameterType="TransDTO" resultMap="TransMap">
		SELECT trans_no, trans_type, trans_amount, category, trans_desc, trans_date, dept_name
		FROM transaction
		JOIN department USING(dept_no)
		<where>
			<if test="startDate != null and endDate != null">
				trans_date BETWEEN #{startDate} AND #{endDate}
			</if>
			<if test="transType != 'all'">
				AND trans_type = #{transType}
			</if>
			<if test="deptName != 'all'">
				AND dept_name = #{deptName}
			</if>
			<if test="transDesc != null and transDesc != ''">
				AND trans_desc LIKE CONCAT ('%', #{transDesc}, '%')
			</if>
		</where>
		ORDER BY trans_date
	</select>
	
	<select id="showtransPage" parameterType="TransPagingDTO" resultMap="TransMap">
		SELECT trans_no, trans_type, trans_amount, category, trans_desc, trans_date, dept_name
		FROM transaction
		JOIN department USING(dept_no)
		<where>
			<if test="transDTO.startDate != null and transDTO.endDate != null">
				trans_date BETWEEN #{transDTO.startDate} AND #{transDTO.endDate}
			</if>
			<if test="transDTO.transType != 'all'">
				AND trans_type = #{transDTO.transType}
			</if>
			<if test="transDTO.deptName != 'all'">
				AND dept_name = #{transDTO.deptName}
			</if>
			<if test="transDTO.transDesc != null and transDTO.transDesc != ''">
				AND trans_desc LIKE CONCAT ('%', #{transDTO.transDesc}, '%')
			</if>
		</where>
		ORDER BY trans_date
		LIMIT #{offset}, #{limit}
	</select>
	
	<select id="totalTransPage" parameterType="TransDTO" resultType="int">
		SELECT count(*)
		FROM transaction
		JOIN department USING(dept_no)
		<where>
			<if test="startDate != null and endDate != null">
				trans_date BETWEEN #{startDate} AND #{endDate}
			</if>
			<if test="transType != 'all'">
				AND trans_type = #{transType}
			</if>
			<if test="deptName != 'all'">
				AND dept_name = #{deptName}
			</if>
			<if test="transDesc != null and transDesc != ''">
				AND trans_desc LIKE CONCAT ('%', #{transDesc}, '%')
			</if>
		</where>
		ORDER BY trans_date
	</select>
	
	<insert id="transRegister" parameterType="ArrayList">
		INSERT INTO transaction(trans_type, trans_amount, category, trans_desc, trans_date, dept_no) VALUES
		<foreach collection="tList" item="trans" separator=",">
		(#{trans.transType},#{trans.transAmount},#{trans.category},#{trans.transDesc},#{trans.transDate},#{trans.deptNo})
		</foreach>
		ON DUPLICATE KEY UPDATE
			trans_amount = VALUES(trans_amount),
			trans_desc = VALUES(trans_desc),
			trans_type = VALUES(trans_type)
	</insert>
	
	<select id="monthIncomeChart" resultMap="TransMap">
		SELECT DATE_FORMAT(trans_date, '%Y-%m') AS trans_month, SUM(trans_amount) AS month_income
		FROM transaction
		JOIN department USING(dept_no)
		WHERE trans_type = '수입'
			AND	DATE_FORMAT(trans_date, '%Y-%m')
				BETWEEN DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 6 MONTH), '%Y-%m')
				AND DATE_FORMAT(CURDATE(), '%Y-%m')
		GROUP BY DATE_FORMAT(trans_date, '%Y-%m')
		ORDER BY trans_month
	</select>
	
	<select id="monthExpensesChart" resultMap="TransMap">
		SELECT DATE_FORMAT(trans_date, '%Y-%m') AS trans_month, SUM(trans_amount) AS month_expenses
		FROM transaction
		JOIN department USING(dept_no)
		WHERE trans_type = '지출'
			AND	DATE_FORMAT(trans_date, '%Y-%m')
				BETWEEN DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 6 MONTH), '%Y-%m')
				AND DATE_FORMAT(CURDATE(), '%Y-%m')
		GROUP BY DATE_FORMAT(trans_date, '%Y-%m')
		ORDER BY trans_month
	</select>
	
	<select id="transExpenses" resultMap="BalanceMap">
		SELECT dept_no, dept_name, SUM(trans_amount) AS expenses
		FROM transaction
		JOIN department USING(dept_no)
		WHERE trans_type = '지출'
		GROUP BY dept_no, dept_name
	</select>
</mapper>