<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.erp.qam.mapper.SaleMapper">

	<resultMap id="saleMap" type="SaleReadyDTO">
		<result column="sale_no" property="saleNo" />
		<result column="sale_date" property="saleDate" />
		<result column="product_no" property="productNo" />

		<result column="product_code" property="productCode" />
		<result column="product_price" property="productPrice" />

		<result column="product_category" property="productCategory" />
		<result column="product_name" property="productName" />
		<result column="quantity" property="quantity" />
	        
        <result column="brand_code" property="brandCode"/>
        <result column="brand_name" property="brandName"/>
        
        <result column="sale_registerd" property="saleRegisterd"/>
        <result column="total_price" property="totalPrice"/>
	</resultMap>
	
	<resultMap id="SaleReadyForListDTOMap" type="SaleReadyForListDTO">
		<result column="sale_no" property="saleNo" />
		<result column="sale_date" property="saleDate" />
		<result column="product_no" property="productNo" />

		<result column="product_code" property="productCode" />
		<result column="product_price" property="productPrice" />

		<result column="product_category" property="productCategory" />
		<result column="product_name" property="productName" />
		<result column="quantity" property="quantity" />
	        
        <result column="brand_code" property="brandCode"/>
        <result column="brand_name" property="brandName"/>
	</resultMap>

	<insert id="insertSale" parameterType="Sale">
		INSERT INTO sale (sale_date, product_no)
		VALUES (#{saleDate}, #{productNo})
	</insert>

	<delete id="deleteByProductNo" parameterType="int">
		DELETE FROM sale WHERE product_no = #{productNo}
	</delete>

	<select id="showSaleDone" resultMap="saleMap">
		SELECT
			product_no,
			product_code,
			product_name,
			product_category,
			product_price,
			sale_no,
			sale_date,
			brand_code,
			brand_name
		FROM sale
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		JOIN brand USING(brand_code)
		WHERE sale_date IS NOT NULL
		ORDER BY sale_date DESC
<!--		LIMIT #{offset}, #{limit}-->
	</select>
	
	<select id="totalSaleDone" resultType="int">
		SELECT
			count(*)
		FROM sale
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		WHERE sale_date IS NOT NULL
		ORDER BY sale_date DESC
	</select>

	<select id="showSaleNull"  resultMap="saleMap">
		SELECT
			product_no,
			product_code,
			product_price,
			product_name,
			product_category,
			sale_no,
			sale_date,
			brand_code,
			brand_name
		FROM sale
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		JOIN brand USING(brand_code)
		WHERE sale_date IS NULL
		ORDER BY sale_no ASC
		
	</select>
	
	<select id="totalSaleReady" resultType="int">
		SELECT
			count(*)
		FROM sale
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		WHERE sale_date IS NULL
		ORDER BY sale_no ASC
	</select>

	<select id="findBySaleNo" parameterType="int" resultMap="saleMap">
		SELECT
			sale_no,
			product_no,
			product_code,
			product_name,
			product_price,
			product_category,
			sale_date,
			brand_code,
			brand_name
		FROM sale 
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		JOIN brand USING(brand_code)
		WHERE sale_no = #{saleNo}
	</select>

	<update id="registerSaleDate" parameterType="SaleReadyDTO">
		UPDATE sale
		SET sale_date = #{saleDate}
		WHERE sale_no = #{saleNo}
	</update>

	<select id="dailySale" parameterType="SaleReadyDTO" resultMap="saleMap">
		SELECT
			product_name,
			product_code,
			product_price,
			sale_date,
			count(*) AS quantity 
		FROM sale
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		WHERE sale_date = #{saleDate}
			AND sale_registered = 'N'
		GROUP BY product_name, product_code, product_price, sale_date
	</select>
	
	<update id="updateSaleRegistered" parameterType="SaleManage">
		UPDATE sale
    	SET sale_registered = 'Y'
    	WHERE sale_date = #{saleDate}
	</update>

	<select id="searchSaleDone" parameterType="SaleReadyDTO" resultMap="SaleReadyForListDTOMap"> 
		SELECT 
			sale_no,
			product_no,
			product_code, 
			product_name, 
			product_price,
			product_category, 
			sale_date,
			brand_code,
			brand_name
		FROM sale  
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		JOIN brand USING(brand_code)
		<where>
		sale_date IS NOT NULL 
		<if test="productCategory != null and productCategory != ''">
			AND product_category = #{productCategory}
		</if> 
		<if test="startDate != null ">
			AND sale_date <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null ">
			AND sale_date <![CDATA[<=]]> #{endDate}
		</if>
		</where>
		ORDER BY sale_date DESC
		LIMIT #{offset}, #{limit}
	</select>
	
	<select id="serachSaleDoneTotal" parameterType="SaleReadyDTO" resultType="int"> 
		SELECT 
			count(*)
		FROM sale  
		JOIN product USING(product_no)
		JOIN product_name USING(product_code)
		JOIN brand USING(brand_code)
		<where>
		sale_date IS NOT NULL 
		<if test="productCategory != null and productCategory != ''">
			AND product_category = #{productCategory}
		</if> 
		<if test="startDate != null ">
			AND sale_date <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null ">
			AND sale_date <![CDATA[<=]]> #{endDate}
		</if>
		</where>
		ORDER BY sale_date DESC
<!--		LIMIT #{offset}, #{limit}-->
	</select>

	<select id="totalPriceSum" parameterType="SaleReadyDTO" resultType="int">
	    SELECT COALESCE(SUM(product_price), 0) AS total_price
	    FROM sale
	    JOIN product USING(product_no)
	    JOIN product_name USING(product_code)
	    JOIN brand USING(brand_code)
	    <where>
	        sale_date IS NOT NULL
	        <if test="productCategory != null and productCategory != ''">
	            AND product_category = #{productCategory}
	        </if>
	        <if test="startDate != null">
	            AND sale_date <![CDATA[>=]]> #{startDate}
	        </if>
	        <if test="endDate != null">
	            AND sale_date <![CDATA[<=]]> #{endDate}
	        </if>
	    </where>
	</select>

</mapper>
