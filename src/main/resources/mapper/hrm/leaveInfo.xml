<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.hrm.mapper.LeaveInfoMapper">

<resultMap type="LeaveInfo" id="LeaveInfoMap">
   <id column="leave_id" property="leaveId"/>
   <result column="leave_type" property="leaveType"/>
   <result column="request_date" property="requestDate"/>
   <result column="start_date" property="startDate"/>
   <result column="end_date" property="endDate"/>
   <result column="emp_no" property="empNo"/>
   <result column="reason" property="reason"/>
   <result column="status" property="status" />
   <result column="emp_name" property="empName"/>
   <result column="dept_name" property="deptName"/>
   <result column="job_title" property="jobTitle"/>
   <result column="total_days" property="totalDays"/>
   <result column="remain_days" property="remainDays"/>
</resultMap>

<!-- 사번을 조회하여 신청된 휴가 조회, 조회 시 신청된 시간 순서대로 정렬-->
<select id="leaveInfo" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type, start_date, end_date, reason, status, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)

	<where>
	    emp_no = #{empNo}
	  <if test='status == "wait"'>
	    AND status = '대기'
	  </if>
	  <if test='status == "approve"'>
	    AND status = '승인'
	  </if>
	  <if test='status == "back"'>
	    AND status = '반려'
	  </if>
	  
	</where>

ORDER BY leave_id DESC
</select>

<!-- 휴가 신청, 사번, 신청 날짜, 휴가 유형, 휴가 시작일,  종료일, 사유 작성-->
<insert id="leaveAdd" parameterType="ArrayList">
INSERT INTO leave_request(emp_no, request_date, leave_type, start_date, end_date, reason) 
VALUES 
<foreach collection="liList" item="leave" separator=",">
		   (#{leave.empNo}, #{leave.requestDate}, #{leave.leaveType}, #{leave.startDate}, #{leave.endDate}, #{leave.reason})
</foreach>
</insert>

<!-- 휴가 승인 상태 변경을 위한 신청 리스트 신청 순서대로 정렬-->
<select id="leaveStatus" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type,emp_no, start_date, end_date, reason, status, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
WHERE status = '대기'
ORDER BY leave_id DESC
LIMIT #{offset}, #{limit}
</select>

<select id="totalLeaveInfo" resultType="int">
SELECT count(leave_id) FROM leave_request WHERE status = '대기'
</select>

<!-- 신청된 휴가 내역 리스트 보고 대기->승인/반려 로 상태 변경-->
<update id="leaveStatusUpdate" parameterType="LeaveInfo">
UPDATE leave_request
SET status = #{status}
WHERE leave_id = #{leaveId}
</update>

<!-- 사번으로 검색하여 사용한 누적휴가일수와 남은 휴가일수 조회-->
<select id="leaveDays" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
<!--SELECT emp_no, emp_name, dept_name, job_title, 
IFNULL(SUM(DATEDIFF(end_date, start_date) + 1), 0) AS 'total_days', 
12 - IFNULL(SUM(DATEDIFF(end_date, start_date) + 1), 0) AS 'remain_days'
FROM leave_request
     JOIN employee_info using(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
WHERE emp_no= #{empNo} 
AND status = '승인'
AND YEAR(start_date) = YEAR(CURDATE())-->
SELECT emp_no, emp_name, dept_name, job_title
FROM employee_info
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
WHERE emp_no= #{empNo}
</select>

<!-- 
승인된 휴가만 휴가 누적 사용일수에 포함
휴가 누적 사용일수 = 12개 - {(종료일-시작일)+1} -->
<select id="leaveTotalDays" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT end_date, start_date
FROM leave_request
WHERE emp_no = #{empNo} 
      AND (status = '승인' OR status = '대기')
</select>

<select id="leaveInfoView" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type, start_date, end_date, reason, status, emp_no, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
WHERE leave_id = #{leaveId}
</select>    
    
<!-- 휴가 정보 수정 -->
<update id="leaveUpdate" parameterType="LeaveInfo">
UPDATE leave_request
SET start_date=#{startDate}, end_date=#{endDate}, reason=#{reason}
WHERE leave_id=#{leaveId}
</update>

<!-- 휴가 삭제 -->
<delete id="leaveDelete" parameterType="int">
DELETE FROM leave_request WHERE leave_id = #{leaveId}
</delete>

<select id="leaveInfoPage" parameterType="LeaveInfoPagingDTO" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type, start_date, end_date, reason, status, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
<if test="empNo != null">
	<where>
	    emp_no = #{empNo}
	  <if test='status == "wait"'>
	    AND status = '대기'
	  </if>
	  <if test='status == "approve"'>
	    AND status = '승인'
	  </if>
	  <if test='status == "back"'>
	    AND status = '반려'
	  </if>
	  
	</where>
</if>
ORDER BY leave_id DESC
LIMIT #{offset}, #{limit}
</select>

<select id="totalMyLeaveInfo" parameterType="LeaveInfoPagingDTO" resultType="int">
SELECT count(*)
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
<if test="empNo != null">
	<where>
	    emp_no = #{empNo}
	  <if test='status == "wait"'>
	    AND status = '대기'
	  </if>
	  <if test='status == "approve"'>
	    AND status = '승인'
	  </if>
	  <if test='status == "back"'>
	    AND status = '반려'
	  </if>
	  
	</where>
</if>
</select>

<!-- 겹치는 휴가일 조회, CDATA: 기호오류 방지-->
<select id="checkApprove" parameterType="LeaveInfo" resultType="int">
<![CDATA[
SELECT COUNT(*)
FROM leave_request
WHERE (status = '승인' OR status = '대기')
AND emp_no = #{empNo}
AND (end_date >= #{startDate} AND start_date <= #{endDate})
]]> 
<if test="leaveId != null and leaveId != ''">
    AND leave_id != #{leaveId}  <!-- 수정할 때만 자기 자신 제외 -->
</if>
</select>

<!-- 출퇴근 기록 존재 여부 -->
<select id="checkAttendanceExists" resultType="int">
    SELECT COUNT(*) FROM attendance_log 
    WHERE emp_no = #{empNo}
      AND work_date = #{workDate}
</select>

<!-- 출퇴근 기록 UPDATE (이미 존재하면 휴가로 수정) -->
<update id="updateAttendanceLeave">
    UPDATE attendance_log
    SET status = '휴가',
        check_in = '00:00:00',
        check_out = '00:00:00'
    WHERE emp_no = #{empNo}
      AND work_date = #{workDate}
</update>

<!-- 출퇴근 기록 INSERT (없으면 새로 추가) -->
<insert id="insertAttendanceLeave">
    INSERT INTO attendance_log (emp_no, work_date, check_in, check_out, status)
    VALUES (#{empNo}, #{workDate}, '00:00:00', '00:00:00', '휴가')
</insert>

</mapper>