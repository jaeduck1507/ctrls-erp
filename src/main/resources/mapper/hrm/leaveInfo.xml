<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.erp.hrm.mapper.LeaveInfoMapper">

<resultMap type="LeaveInfo" id="LeaveInfoMap">
   <id column="leave_id" property="leaveId"/>
   <result column="leave_type" property="leaveType"/>
   <result column="request_date" property="requestDate"/>
   <result column="start_date" property="startDate"/>
   <result column="end_date" property="endDate"/>
   <result column="emp_no" property="empNo"/>
   <result column="reason" property="reason"/>
   <result column="status" property="status" />
   <result column="emp_name" property="empName"/>
   <result column="dept_name" property="deptName"/>
   <result column="job_title" property="jobTitle"/>
   <result column="total_days" property="totalDays"/>
   <result column="remain_days" property="remainDays"/>
</resultMap>

<select id="leaveInfo" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type, start_date, end_date, reason, status, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
<where>
	<if test="empNo != null" >
		emp_no = #{empNo}
	</if>
</where>
ORDER BY request_date DESC
</select>

<insert id="leaveAdd" parameterType="ArrayList">
INSERT INTO leave_request(emp_no, request_date, leave_type, start_date, end_date, reason) 
VALUES 
<foreach collection="liList" item="leave" separator=",">
		   (#{leave.empNo}, #{leave.requestDate},#{leave.leaveType},#{leave.startDate},#{leave.endDate},#{leave.reason})
</foreach>
</insert>

<update id="leaveStatusUpdate" parameterType="LeaveInfo">
UPDATE leave_request
SET status = #{status}
WHERE leave_id = #{leaveId}
</update>
<select id="leaveStatus" resultMap="LeaveInfoMap">
SELECT leave_id, request_date, leave_type,emp_no, start_date, end_date, reason, status, emp_name, dept_name, job_title
FROM leave_request
     JOIN employee_info USING(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
ORDER BY leave_id ASC
</select>

<select id="leaveDays" parameterType="LeaveInfo" resultMap="LeaveInfoMap">
SELECT emp_no, emp_name, dept_name, job_title, SUM(DATEDIFF(end_date, start_date) + 1) AS 'total_days', 12 - SUM(DATEDIFF(end_date, start_date) + 1) AS 'remain_days'
FROM leave_request
     JOIN employee_info using(emp_no)
     JOIN department USING(dept_no)
     JOIN job_position USING(job_no)
WHERE emp_no= #{empNo} 
AND status = '승인'
AND YEAR(start_date) = YEAR(CURDATE())
</select>
<update id="leaveUpdate" parameterType="LeaveInfo">
UPDATE leave_request
SET leave_type=#{leaveType}, start_date=#{start_date}, end_date=#{end_date}, reason=#{reason}
WHERE emp_no=#{empNo}
AND status= '대기'
</update>

</mapper>